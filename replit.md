# Football Play Designer

## Overview

The Football Play Designer is a free, web-based tool enabling amateur coaches to create offensive, defensive, and special teams plays. It features a drag-and-drop canvas for player positioning and route drawing, with the ability to export plays as images. Designed as a single-page application, it requires no authentication and is optimized for accessibility across desktop, tablet, and mobile devices. The project aims to provide a user-friendly and efficient play design experience, catering to the needs of grassroots football coaching.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Frontend Architecture

The frontend is built with **React** and **TypeScript** using **Vite** for fast development. UI components leverage **shadcn/ui** (based on Radix UI) and **Tailwind CSS** for a consistent and customizable design system. State management primarily uses **React hooks** due to the UI-centric nature of the application. **Wouter** handles client-side routing. The design system uses custom CSS variables for theming, including dark mode, aligning with defined design guidelines.

### Canvas and Drawing System

The core play design functionality utilizes **HTML5 Canvas** and SVG for rendering. A central `FIELD` configuration object defines all field geometry (e.g., `FIELD.WIDTH`, `FIELD.HEIGHT`, `FIELD.PIXELS_PER_YARD`), ensuring consistent scaling and layout. The field is vertically oriented (694×392px) with a 60px header for metadata. Key features include:

-   **Field Elements**: Line of scrimmage, yard lines, hash marks, draggable footballs, and a play-action marker.
-   **Motion Routes**: Displayed with a visual split at the Line of Scrimmage (dotted before, solid after).
-   **Export Functionality**: Uses `html-to-image` to generate downloadable PNGs. Exports at native size (694x392) maintain pixel-perfect quality, while other sizes are generated by capturing at 2x resolution and downscaling with high-quality smoothing for crisp results.
-   **Interaction Model**: Drag-and-drop for players, click-to-draw for routes. A **long-press cascading menu** on players allows mouse-only route creation with options for route type and properties.
-   **Player Interactions**: Quick tap to select, double tap to edit label, long-press for route menu, drag to move.

### Player Rendering

Players have a `side` property (`"offense"` or `"defense"`) that determines their visual rendering:

-   **Offensive Players**: Rendered as filled circles with centered labels (white text on colored background).
-   **Defensive Players**: Rendered as X shapes (SVG with two crossed lines, strokeWidth 4) with labels in white pill-shaped badges positioned above the X.

**Defense 5v5 Formation** (loaded via Defense tab + 5-on-5 button):
-   Uses SPACING = 60px base unit for broad "W" formation
-   Row 1 (Linebackers): 3x "LB" at centerX and centerX ± (3.5 * SPACING) = ±210px (wide near hashmarks), Y = LOS - 40, Light Blue (#87CEEB)
-   Row 2 (Defensive Backs): 2x "DB" at centerX ± (1.8 * SPACING) = ±108px (in gaps), Y = LOS - 100, Purple (#9333ea)
-   "Add Offense?" toggle: Defaults to CHECKED. When checked, loads BOTH defense5v5 AND offense5v5 players (10 total); when unchecked, loads only defense (5 total)

**Defensive Assignment System** (long-press menu on defensive players):
-   **Assignment Column**: Blitz, Man, Zone options
-   **Style Column**: Linear, Area styles (appears when Assignment is hovered/selected)
-   **Blitz**: Creates red solid line (#ef4444) from defender to QB position (auto-targeted)
-   **Man Coverage**: Creates gray dotted line (#9ca3af, strokeDasharray: "5,5") to nearest unclaimed offensive player (auto-targeted with dynamic linking)
-   **Zone Coverage**: Creates tethered zone shapes via Zone → Area → Shape selection (Circle, Oval, Rectangle)
-   **Dynamic Linking**: Man coverage routes automatically update their endpoints when the target offensive player is moved (uses useEffect watching players and routes state)

**Zone Coverage Tethered Shape System**:
-   **Shape Types**: Circle (50x50), Oval (70x45), Rectangle (60x45) - spawned at player position
-   **Tethering**: Shapes are connected to their player via a "stem" line (solid line in player's color)
-   **Stem Visibility**: Stem hides when player overlaps shape (distance threshold ~30px)
-   **Independent Dragging**: Shapes can be dragged independently; stem updates dynamically
-   **Resize Handles**: 4 corner handles (nw, ne, sw, se) appear when shape is selected
-   **Resize Logic**: Min size 20px, shapes stay within field bounds
-   **Z-Order**: Stems → Shapes → Routes → Players (shapes render behind players)
-   **Shape State**: Each shape has playerId for tethering, type, x/y/width/height, and color (inherits from player)

**Defense Color-Label Mapping** (consistent across manual add and presets):
-   Pink (#FFB6C1) → "DL" (Defensive Line)
-   Light Blue (#87CEEB) → "LB" (Linebacker)
-   Purple (#9333ea) → "DB" (Defensive Back)

**Defensive Label Styling** (Tailwind classes):
-   Container: `w-4 h-4 rounded-full bg-white flex items-center justify-center shadow-sm absolute top-0`
-   Font: `text-[9px] font-bold text-black`
-   Positioned just above the X shape

### AI Play Creator (Special Tab)

The Special Teams tab features an **AI Play Creator** powered by **Google Gemini 2.0 Flash**. Users can describe a play in natural language or upload an image of a play diagram, and the AI generates players and routes on the canvas.

**Backend Endpoint**: `POST /api/generate-play`
- Accepts `{ prompt: string, image?: string }` (image is base64)
- Uses Gemini with a detailed system prompt teaching the coordinate system
- Returns `{ players: Player[], routes: Route[] }` in validated JSON format

**System Prompt Configuration**:
- Field dimensions: 694×392 pixels
- LOS at Y = 284
- Player color codes for QB (#000000), RB/WR (#39ff14), TE (#eab308), OL (#f97316), etc.
- Route types: straight, curved, zigzag
- Route styles: solid, dashed

**Frontend Integration**:
- Glassmorphic input container with textarea and suggestion chips
- Upload Play button converts images to base64 for multimodal vision analysis
- Submit button shows loading spinner during generation
- Success: players and routes render on canvas, toast notification
- Error: descriptive toast with error message

**Environment Variables**:
- `GEMINI_API_KEY`: Required secret for Gemini API access

### Backend Architecture

The backend uses **Express.js** with **TypeScript** on Node.js. It's designed to be lightweight, primarily serving static assets, with most application logic handled client-side. Separate entry points (`index-dev.ts`, `index-prod.ts`) manage development with Vite integration and production serving. API routes are prefixed with `/api`.

### Data Storage and Persistence

**Drizzle ORM** configured with **PostgreSQL** (via **Neon Database**) is used for type-safe database operations, although the MVP relies on client-side storage for plays (e.g., `localStorage`) due to the "no login" requirement. An in-memory `MemStorage` is used for development. A basic `users` schema exists, likely for future authentication. Play data, when persistent, will include metadata, player positions, routes, shapes, and play type.

### Play Type Tabs and State Separation

The application features three play type tabs (Offense, Defense, Special Teams), each maintaining completely independent state (players, routes, shapes, footballs, metadata, undo history). Tab switching saves the current state and loads the target tab's state, clearing selections. The Defense tab includes a "Add Offense?" checkbox to load offensive formations for defensive play design. QB positioning logic is specific to the "Offense" tab to avoid unintended movement of defensive players.

### Dynamic Header Layout (Defense Tab Optimization)

To maximize field space for deep defensive zones, the layout dynamically flips based on the active tab:

**Offense/Special Teams Layout:**
- White header at TOP (y = 0 to 60)
- Green field BELOW (y = 60 to 392)
- Player bounds: minY = 72, maxY = 368

**Defense Layout:**
- Green field at TOP (y = 0 to 332)
- White header at BOTTOM (y = 332 to 392)
- Player bounds: minY = 12, maxY = 320

**Key Constants (unchanged):**
- Canvas dimensions: 694×392 (export size unchanged)
- LOS_Y: 284 (absolute position unchanged)
- FIELD_HEIGHT: 332 (playable area)

**Implementation:**
- `FIELD.getFieldStartY(activeTab)`: Returns 0 for defense, 60 for offense
- `FIELD.getHeaderStartY(activeTab)`: Returns 332 for defense, 0 for offense
- `FIELD.getPlayerBounds(activeTab)`: Returns dynamic minY/maxY based on tab
- Formation loading clamps players to current tab bounds via `clampPlayersToCurrentBounds()`

## External Dependencies

### Third-Party UI Libraries

-   **Radix UI**: Accessible component primitives.
-   **shadcn/ui**: Styled components built on Radix UI.
-   **Lucide React**: Icon library.
-   **class-variance-authority (CVA)**: For variant-based component APIs.

### Forms and Validation

-   **React Hook Form**: Form state management.
-   **Zod**: Schema validation.

### Database and ORM

-   **Drizzle ORM**: Type-safe database toolkit.
-   **@neondatabase/serverless**: PostgreSQL client for Neon.
-   **drizzle-kit**: Schema migration tool.

### Utilities and Tooling

-   **TanStack Query**: Data fetching and caching.
-   **date-fns**: Date manipulation.
-   **clsx & tailwind-merge**: Utility for classNames.
-   **html-to-image**: DOM to image conversion for exports.

### Build Tools

-   **Vite**: Frontend build tool.
-   **esbuild**: Server bundling.
-   **TypeScript**: Type checking.
-   **PostCSS**: CSS processing.

### Replit Integration

-   **@replit/vite-plugin-runtime-error-modal**: Error overlay.
-   **@replit/vite-plugin-cartographer**: Workspace integration.
-   **@replit/vite-plugin-dev-banner**: Development banner.

### Session Management

-   **connect-pg-simple**: PostgreSQL session store for Express (currently configured).

### Canvas/Graphics

-   **embla-carousel-react**: Carousel component.
-   **vaul**: Drawer component library.